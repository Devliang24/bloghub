
# FastAPI æ•™ç¨‹ - 09. ä¾èµ–æ³¨å…¥å…¥é—¨

> **é€‚åˆäººç¾¤**ï¼šè¿›é˜¶å¼€å‘è€…
> **å‰ç½®çŸ¥è¯†**ï¼šPython å‡½æ•°
> **é¢„è®¡æ—¶é—´**ï¼š20 åˆ†é’Ÿ

## ğŸ§© ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ

**ä¾èµ–æ³¨å…¥ (Dependency Injection, DI)** å¬èµ·æ¥å¾ˆæ·±å¥¥ï¼Œä½†åœ¨ FastAPI ä¸­å®ƒéå¸¸ç®€å•ä¸”å®ç”¨ã€‚

å®ƒä¸»è¦ç”¨äºï¼š
*   å…±äº«é€»è¾‘ï¼ˆä»£ç å¤ç”¨ï¼‰ã€‚
*   å…±äº«æ•°æ®åº“è¿æ¥ã€‚
*   å®ç°å®‰å…¨è®¤è¯ã€æƒé™éªŒè¯ã€‚
*   å‡å°‘ä»£ç é‡å¤ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯**ä½ éœ€è¦ä»€ä¹ˆï¼ŒFastAPI å°±ç»™ä½ é€è¿‡æ¥**ã€‚

### ä¾èµ–è§£æè¿‡ç¨‹

```mermaid
graph LR
    Req[Request] --> Dep1[Dependency A]
    Req --> Dep2[Dependency B]
    Dep1 --> PathOp["Path Operation<br>(Function)"]
    Dep2 --> PathOp
    
```

## ğŸ› ï¸ åˆ›å»ºä¸€ä¸ªä¾èµ–é¡¹

ä¾èµ–é¡¹å°±æ˜¯ä¸€ä¸ªç®€å•çš„ Python å‡½æ•°ï¼ˆå¯ä»¥æ˜¯å¼‚æ­¥ `async` ä¹Ÿå¯ä»¥æ˜¯åŒæ­¥ï¼‰ã€‚

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåˆ†é¡µçš„é€»è¾‘ï¼Œåœ¨å¾ˆå¤šæ¥å£éƒ½è¦ç”¨åˆ° `skip` å’Œ `limit`ã€‚

```python
from fastapi import FastAPI, Depends

app = FastAPI()

# 1. å®šä¹‰ä¾èµ–å‡½æ•°
async def common_parameters(q: str | None = None, skip: int = 0, limit: int = 100):
    return {"q": q, "skip": skip, "limit": limit}

# 2. åœ¨è·¯å¾„æ“ä½œä¸­ä½¿ç”¨ Depends
@app.get("/items/")
async def read_items(commons: dict = Depends(common_parameters)):
    return commons

@app.get("/users/")
async def read_users(commons: dict = Depends(common_parameters)):
    return commons
```

### ä»£ç è§£æ

1.  **å®šä¹‰ä¾èµ–**ï¼š`common_parameters` æ¥æ”¶ `q`, `skip`, `limit` å‚æ•°ã€‚è¿™å’Œæ™®é€šçš„è·¯å¾„æ“ä½œå‡½æ•°ä¸€æ¨¡ä¸€æ ·ã€‚
2.  **ä½¿ç”¨ä¾èµ–**ï¼šåœ¨ `read_items` ä¸­ï¼Œæˆ‘ä»¬å°†å‚æ•° `commons` å£°æ˜ä¸ºä¾èµ–äº `common_parameters`ã€‚
3.  **æ‰§è¡Œæµç¨‹**ï¼š
    *   å½“è¯·æ±‚ `/items/` æ—¶ï¼ŒFastAPI å‘ç°éœ€è¦ `commons`ã€‚
    *   å®ƒä¼šå…ˆè°ƒç”¨ `common_parameters` å‡½æ•°ã€‚
    *   è§£æ URL ä¸­çš„ `q`, `skip`, `limit` ä¼ ç»™è¿™ä¸ªå‡½æ•°ã€‚
    *   è·å–å‡½æ•°è¿”å›å€¼ï¼Œèµ‹å€¼ç»™ `commons`ã€‚
    *   æœ€åæ‰§è¡Œ `read_items` é€»è¾‘ã€‚

## ğŸ“¦ åµŒå¥—ä¾èµ–

ä¾èµ–é¡¹å¯ä»¥ä¾èµ–äºå…¶ä»–ä¾èµ–é¡¹ï¼

```python
def query_extractor(q: str | None = None):
    return q

def query_or_cookie_extractor(
    q: str = Depends(query_extractor), 
    last_query: str | None = None
):
    if not q:
        return last_query
    return q

@app.get("/items/")
async def read_query(query_str: str = Depends(query_or_cookie_extractor)):
    return {"query_string": query_str}
```

FastAPI ä¼šè‡ªåŠ¨æ„å»ºä¾èµ–å›¾ï¼ˆDependency Graphï¼‰å¹¶æŒ‰æ­£ç¡®é¡ºåºæ‰§è¡Œã€‚

## ğŸ“š æ€»ç»“

*   ä¾èµ–æ³¨å…¥ç”¨äºä»£ç å¤ç”¨å’Œé€»è¾‘è§£è€¦ã€‚
*   ä¾èµ–é¡¹å°±æ˜¯æ™®é€šå‡½æ•°ã€‚
*   ä½¿ç”¨ `Depends(func)` å°†ä¾èµ–æ³¨å…¥åˆ°è·¯å¾„æ“ä½œä¸­ã€‚
*   FastAPI è‡ªåŠ¨å¤„ç†å‚æ•°è·å–å’Œä¾èµ–æ‰§è¡Œé¡ºåºã€‚

ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨**ç±»**ä½œä¸ºä¾èµ–é¡¹ï¼Œè¿™åœ¨å¤„ç†å¤æ‚é€»è¾‘æ—¶éå¸¸æœ‰ç”¨ã€‚
